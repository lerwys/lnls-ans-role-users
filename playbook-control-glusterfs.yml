---
- hosts: control_room_all
  remote_user: sirius
  become: true
  become_method: sudo
  become_user: root

  pre_tasks:
    - name: Include distribution-dependent variables
      include_vars: "{{ item }}"
      vars:
        possible_var_files:
          - "group_vars/{{ ansible_distribution }}-{{ ansible_distribution_release }}.yml"
          - "group_vars/{{ ansible_distribution }}.yml"
          - "group_vars/{{ ansible_os_family }}.yml"
      loop: "{{ q('first_found', possible_var_files, errors='ignore') }}"

  tasks:
    - name: "Gluster packages"
      apt:
        name: "{{ item }}"
      loop:
        - glusterfs-common
        - glusterfs-server

    - name: "Create gluster brick directory"
      file:
        path: /data/gluster/hdd-01/shared-brick
        state: directory
        mode: "0755"

    - name: Glusterfs service name
      set_fact:
        service_glusterfs_server: glusterd
      when: service_glusterfs_server is not defined

    - name: "Gluster Service"
      service:
        name: "{{ service_glusterfs_server }}"
        state: started
        enabled: yes
  roles:
    - role: lnls-ans-role-nfsclient
